---
import '@/styles/app.scss';
---
<section class="contact">
  <form class="contact__form" id="contact-form">
    <div class="contact__form-group">
      <label for="username" class="contact__label">Nombre</label>
      <input
        id="username"
        type="text"
        name="username"
        placeholder="Tu nombre..."
        class="contact__input"
      />
      <p class="contact__message contact__message--error"></p>
    </div>

    <div class="contact__form-group">
      <label for="email" class="contact__label">Correo Electrónico</label>
      <input
        id="email"
        type="email"
        name="email"
        placeholder="Ejemplo@gmail.com"
        class="contact__input"
      />
      <p class="contact__message contact__message--error"></p>
    </div>

    <div class="contact__form-group">
      <label for="message" class="contact__label">Mensaje</label>
      <textarea
        id="message"
        name="message"
        placeholder="Escribe tu mensaje aquí"
        class="contact__textarea"
      ></textarea>
      <p class="contact__message contact__message--error"></p>
    </div>

    <!-- honeypot para evitar spam bots -->
    <div class="contact__honeypot" style="display: none;">
      <label for="honeypot">No llenar este campo</label>
      <input type="text" id="honeypot" name="honeypot" />
    </div>

    <div class="contact__form-group">
      <button type="submit" id="submit" class="contact__form-button contact__button--submit">Enviar</button>
    </div>
  </form>
</section>

<script is:inline>
 document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("contact-form");
    const submitBtn = document.getElementById("submit");

    if (!form || !submitBtn) return;

    const validateEmail = (email) => {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    };

    const showError = (message) => {
      Toastify({
        text: message,
        backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
        duration: 3000
      }).showToast();
      submitBtn.disabled = false;
      submitBtn.textContent = "Enviar";
    };

    const showSuccess = (message) => {
      Toastify({
        text: message,
        duration: 3000,
        gravity: "top",
        position: "right",
        backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
      }).showToast();
    };

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      submitBtn.disabled = true;
      submitBtn.textContent = "Enviando...";

      const honeypot = document.getElementById("honeypot")?.value;
      if (honeypot) {
        console.warn("Spam detectado.");
        return;
      }

      const name = document.getElementById("username")?.value.trim();
      const email = document.getElementById("email")?.value.trim();
      const message = document.getElementById("message")?.value.trim();

      if (!name || name.length < 2) {
        showError("El nombre debe tener al menos 2 caracteres");
        return;
      }

      if (!validateEmail(email)) {
        showError("Por favor ingresa un email válido");
        return;
      }

      if (!message || message.length < 10) {
        showError("El mensaje debe tener al menos 10 caracteres");
        return;
      }

      try {
        const res = await fetch("/api/contact", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, email, message })
        });

        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.error || "Error al enviar el mensaje");
        }

        showSuccess("¡Mensaje enviado con éxito!");
        form.reset();
      } catch (err) {
        console.error(err);
        showError(err.message || "Error al enviar el mensaje");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Enviar";
      }
    });
});
</script>
